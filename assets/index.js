function b(){let{pathname:e}=self.location;return e==="/"?"simonpedia":e?e.replace(/^\//,"").replace(/\.html$/,""):""}function v(e){return htmx.findAll("#list > ul > li").forEach(t=>htmx.removeClass(t,"active")),htmx.addClass(htmx.find(`#list > ul > li[data-key="${e}"]`),"active"),!0}function w(){return htmx.find("#list > ul > li.active").scrollIntoView({block:"center"}),!0}function C(){return htmx.toggleClass("aside","hidden"),!0}var O="https://cdn.jsdelivr.net/npm/d3@7/dist/d3.min.js",k=null;function j(e){return[typeof e.source=="string"?e.source:e.source.id,typeof e.target=="string"?e.target:e.target.id]}function P(e){return document.querySelector(`script[src="${e}"]`)?Promise.resolve():new Promise((t,c)=>{let r=document.createElement("script");r.src=e,r.onload=()=>t(),r.onerror=c,document.head.appendChild(r)})}function q(e){let t=document.createElement("a");t.href=`/${e}`,t.setAttribute("hx-get",`/swap/${e}`),t.setAttribute("hx-target","#main"),t.setAttribute("hx-push-url",`/${e}`),t.setAttribute("hx-swap","show:top"),t.setAttribute("hx-on:click",`select('${e}') && scrollToActive()`),document.body.appendChild(t),htmx.process(t),t.click(),t.remove()}function z(e){let t=new Map;for(let c of e){let[r,i]=j(c);t.set(r,(t.get(r)??0)+1),t.set(i,(t.get(i)??0)+1)}return t}function G(e,t,c){let r=new Map,i=Math.min(t,c)*.3;for(let s=0;s<e.length;s++){let n=2*Math.PI*s/e.length;r.set(e[s],{x:t/2+i*Math.cos(n),y:c/2+i*Math.sin(n)})}return r}function H(e,t,c){let r=new Map;for(let n of e)r.set(n.id,n);let i=new Map;for(let n of e)i.set(n.id,new Set([n.category]));for(let n of t){let[f,p]=j(n),u=r.get(f),g=r.get(p);u&&g&&(i.get(f).add(g.category),i.get(p).add(u.category))}let s=new Map;for(let n of e){let f=[...i.get(n.id)];if(f.length===1||n.id===n.category)s.set(n.id,c(n.category));else{let p=0,u=0,g=0,h=0;for(let m of f){let l=m===n.category?3:1,y=d3.color(c(m)).rgb();p+=y.r*l,u+=y.g*l,g+=y.b*l,h+=l}s.set(n.id,d3.rgb(p/h,u/h,g/h).formatHex())}}return s}function R(e,t,c){return d3.forceSimulation(e).alpha(.3).alphaDecay(.03).velocityDecay(.6).force("link",d3.forceLink(t).id(r=>r.id).distance(60)).force("charge",d3.forceManyBody().strength(-100)).force("x",d3.forceX(r=>c.get(r.category).x).strength(.1)).force("y",d3.forceY(r=>c.get(r.category).y).strength(.1)).force("collision",d3.forceCollide().radius(12))}function _(e){return d3.drag().on("start",t=>{t.active||e.alphaTarget(.3).restart(),t.subject.fx=t.subject.x,t.subject.fy=t.subject.y}).on("drag",t=>{t.subject.fx=t.x,t.subject.fy=t.y}).on("end",t=>{t.active||e.alphaTarget(.01),t.subject.fx=null,t.subject.fy=null})}async function A(){k?.stop(),k=null;let e=document.getElementById("graph-container");if(!e)return;e.replaceChildren(),await P(O);let{nodes:t,edges:c}=await fetch("/api/graph").then(o=>o.json()),r=z(c),i=new Map;for(let o of c){let[a,d]=j(o);i.has(a)||i.set(a,new Set),i.has(d)||i.set(d,new Set),i.get(a).add(d),i.get(d).add(a)}let{clientWidth:s,clientHeight:n}=e,f=[...new Set(t.map(o=>o.category))],p=d3.scaleOrdinal(d3.schemeObservable10).domain(f),u=G(f,s,n),g=H(t,c,p);for(let o of t)if(o.id==="simonpedia")o.x=s/2,o.y=n/2,o.fx=s/2,o.fy=n/2;else{let a=u.get(o.category);o.x=a.x+(Math.random()-.5)*80,o.y=a.y+(Math.random()-.5)*80}let h=d3.select(e).append("svg").attr("width",s).attr("height",n),m=h.append("g"),l=!0;h.call(d3.zoom().scaleExtent([.1,4]).on("zoom",o=>{m.attr("transform",o.transform);let a=o.transform.k>=.7;a!==l&&(l=a,E.attr("display",a?null:"none"),a&&S.attr("x",d=>d.x).attr("y",d=>d.y))})),k=R(t,c,u);let y=m.append("g").selectAll("line").data(c).join("line").attr("stroke","#ccc").attr("stroke-opacity",.6).attr("stroke-width",1),L=o=>Math.min(Math.max(3+(r.get(o.id)??0)*.8,4),20),M=m.append("g").selectAll("circle").data(t).join("circle").attr("r",L).attr("fill",o=>g.get(o.id)).attr("stroke","#fff").attr("stroke-width",1.5).attr("cursor","pointer").call(_(k)),E=m.append("g"),S=E.selectAll("text").data(t).join("text").text(o=>o.label).attr("font-size",10).attr("dx",8).attr("dy",3).attr("pointer-events","none").attr("fill","#333");M.on("mouseover",(o,a)=>{let d=i.get(a.id)??new Set,T=new Set([a.id,...d]);M.attr("opacity",x=>T.has(x.id)?1:.1),l&&S.attr("opacity",x=>T.has(x.id)?1:.1),y.attr("stroke-opacity",x=>{let[$,I]=j(x);return $===a.id||I===a.id?.8:.05})}).on("mouseout",()=>{M.attr("opacity",1),l&&S.attr("opacity",1),y.attr("stroke-opacity",.6)}).on("click",(o,a)=>q(a.id)),k.on("tick",()=>{y.attr("x1",o=>o.source.x).attr("y1",o=>o.source.y).attr("x2",o=>o.target.x).attr("y2",o=>o.target.y),M.attr("cx",o=>o.x).attr("cy",o=>o.y),l&&S.attr("x",o=>o.x).attr("y",o=>o.y)})}function B(){self.innerWidth<800&&C(),htmx.find("#search > input").value="",w(),A()}function N(e){e.detail.target.id!=="list"&&(document.title=htmx.find("article > h1").textContent||"",mermaid.run({querySelector:"article div.mermaid"}),v(b()),A())}function V(){v(b()),w(),A()}function D(){document.addEventListener("DOMContentLoaded",B),document.body.addEventListener("htmx:afterSwap",N),document.body.addEventListener("htmx:historyRestore",V)}self.pathname=b;self.select=v;self.scrollToActive=w;self.toggleSidebar=C;D();
