var q=new Map,A=new Map;function P(e){return document.querySelector(`script[src="${e}"]`)?Promise.resolve():new Promise((t,a)=>{let o=document.createElement("script");o.src=e,o.onload=()=>t(),o.onerror=a,document.head.appendChild(o)})}function R(e,t){q.set(e,t)}function T(){for(let[e,t]of A)document.contains(e)||(t.destroy(),A.delete(e));for(let[e,t]of q)for(let a of document.querySelectorAll(`[data-container="${e}"]`))if(!A.has(a)){let o=t();o.init(a),A.set(a,o)}}var I="https://cdn.jsdelivr.net/npm/d3@7/dist/d3.min.js",$="simonpedia";function h(e){return[typeof e.source=="string"?e.source:e.source.id,typeof e.target=="string"?e.target:e.target.id]}function W(e){let t=document.createElement("a");t.href=`/${e}`,t.setAttribute("hx-get",`/swap/${e}`),t.setAttribute("hx-target","#main"),t.setAttribute("hx-push-url",`/${e}`),t.setAttribute("hx-swap","show:top"),t.setAttribute("hx-on:click",`select('${e}') && scrollToActive()`),document.body.appendChild(t),htmx.process(t),t.click(),t.remove()}function B(e){let t=new Map;for(let a of e){let[o,r]=h(a);t.has(o)||t.set(o,new Set),t.has(r)||t.set(r,new Set),t.get(o).add(r),t.get(r).add(o)}return t}function V(e){let t=new Map;for(let a of e){let[o,r]=h(a);t.set(o,(t.get(o)??0)+1),t.set(r,(t.get(r)??0)+1)}return t}function X(e,t,a){let o=Math.min(t,a)*.3;return new Map(e.map((r,n)=>{let s=2*Math.PI*n/e.length;return[r,{x:t/2+o*Math.cos(s),y:a/2+o*Math.sin(s)}]}))}function Y(e){let{r:t,g:a,b:o,total:r}=e.reduce((n,{color:s,weight:i})=>{let l=d3.color(s).rgb();return{r:n.r+l.r*i,g:n.g+l.g*i,b:n.b+l.b*i,total:n.total+i}},{r:0,g:0,b:0,total:0});return d3.rgb(t/r,a/r,o/r).formatHex()}function F(e,t,a){let o=new Map(e.map(n=>[n.id,n])),r=new Map(e.map(n=>[n.id,new Set([n.category])]));for(let n of t){let[s,i]=h(n),l=o.get(s),d=o.get(i);l&&d&&(r.get(s).add(d.category),r.get(i).add(l.category))}return new Map(e.map(n=>{let s=[...r.get(n.id)];return s.length===1||n.id===n.category?[n.id,a(n.category)]:[n.id,Y(s.map(i=>({color:a(i),weight:i===n.category?3:1})))]}))}function J(e,t,a){let o=new Map(e.map(n=>[n.id,n])),r=new Map(e.map(n=>[n.id,new Map([[n.category,3]])]));for(let n of t){let[s,i]=h(n),l=o.get(s),d=o.get(i);if(l&&d){let f=r.get(s);f.set(d.category,(f.get(d.category)??0)+1);let p=r.get(i);p.set(l.category,(p.get(l.category)??0)+1)}}return new Map(e.map(n=>{let s=0,i=0,l=0;for(let[d,f]of r.get(n.id)){let p=a.get(d);s+=p.x*f,i+=p.y*f,l+=f}return[n.id,{x:s/l,y:i/l}]}))}function K(e,t,a,o){for(let r of e)if(r.id===$)r.x=a/2,r.y=o/2,r.fx=a/2,r.fy=o/2;else{let n=t.get(r.id);r.x=n.x+(Math.random()-.5)*80,r.y=n.y+(Math.random()-.5)*80}}function Q(e,t,a){return d3.forceSimulation(e).alpha(.3).alphaDecay(.03).velocityDecay(.6).force("link",d3.forceLink(t).id(o=>o.id).distance(o=>{let[r,n]=h(o);return r===$||n===$?300:100})).force("charge",d3.forceManyBody().strength(-200)).force("x",d3.forceX(o=>a.get(o.id).x).strength(.3)).force("y",d3.forceY(o=>a.get(o.id).y).strength(.3)).force("collision",d3.forceCollide().radius(16))}function U(e){return d3.drag().on("start",t=>{t.active||e.alphaTarget(.3).restart(),t.subject.fx=t.subject.x,t.subject.fy=t.subject.y}).on("drag",t=>{t.subject.fx=t.x,t.subject.fy=t.y}).on("end",t=>{t.active||e.alphaTarget(.01),t.subject.fx=null,t.subject.fy=null})}function Z(){let e=null;return{async init(t){e?.stop(),e=null,t.replaceChildren(),await P(I);let{nodes:a,edges:o}=await fetch("/api/graph").then(c=>c.json()),r=B(o),n=V(o),{clientWidth:s,clientHeight:i}=t,l=[...new Set(a.map(c=>c.category))],d=d3.scaleOrdinal(d3.schemeObservable10).domain(l),f=X(l,s,i),p=J(a,o,f),H=F(a,o,d);K(a,p,s,i);let N=d3.select(t).append("svg").attr("width",s).attr("height",i),M=N.append("g"),g=d3.zoomIdentity,_=Math.min(s,i)*.8,y=null;function k(){if(g.k<.7){L.attr("opacity",0);return}let c=(s/2-g.x)/g.k,u=(i/2-g.y)/g.k,S=y?new Set([y.id,...r.get(y.id)??[]]):null;L.attr("opacity",x=>{if(S)return S.has(x.id)?1:.1;let m=(x.x??0)-c,j=(x.y??0)-u,O=Math.sqrt(m*m+j*j);return Math.max(0,1-O/(_/g.k))})}N.call(d3.zoom().scaleExtent([.1,4]).on("zoom",c=>{g=c.transform,M.attr("transform",c.transform),k()})),e=Q(a,o,p);let D=M.append("g").selectAll("line").data(o).join("line").attr("stroke","#ccc").attr("stroke-opacity",.6).attr("stroke-width",1),G=c=>3+Math.log2(1+(n.get(c.id)??0))*4,C=M.append("g").selectAll("circle").data(a).join("circle").attr("r",G).attr("fill",c=>H.get(c.id)).attr("stroke","#fff").attr("stroke-width",1.5).attr("cursor","pointer").call(U(e)),L=M.append("g").selectAll("text").data(a).join("text").text(c=>c.label).attr("font-size",10).attr("dx",8).attr("dy",3).attr("pointer-events","none").attr("fill","#333").attr("stroke","#fff").attr("stroke-width",1).attr("paint-order","stroke");C.on("mouseover",(c,u)=>{y=u;let S=r.get(u.id)??new Set,x=new Set([u.id,...S]);C.attr("opacity",m=>x.has(m.id)?1:.1),D.attr("stroke-opacity",m=>{let[j,O]=h(m);return j===u.id||O===u.id?.8:.05}),k()}).on("mouseout",()=>{y=null,C.attr("opacity",1),k(),D.attr("stroke-opacity",.6)}).on("click",(c,u)=>W(u.id)),e.on("tick",()=>{D.attr("x1",c=>c.source.x).attr("y1",c=>c.source.y).attr("x2",c=>c.target.x).attr("y2",c=>c.target.y),C.attr("cx",c=>c.x).attr("cy",c=>c.y),L.attr("x",c=>c.x).attr("y",c=>c.y),k()})},destroy(){e?.stop(),e=null}}}R("graph",Z);function b(){let{pathname:e}=self.location;return e==="/"?"simonpedia":e?e.replace(/^\//,"").replace(/\.html$/,""):""}function w(e){return htmx.findAll("#list > ul > li").forEach(t=>htmx.removeClass(t,"active")),htmx.addClass(htmx.find(`#list > ul > li[data-key="${e}"]`),"active"),!0}function v(){return htmx.find("#list > ul > li.active").scrollIntoView({block:"center"}),!0}function E(){return htmx.toggleClass("aside","hidden"),!0}function tt(){self.innerWidth<800&&E(),htmx.find("#search > input").value="",v(),T()}function et(e){e.detail.target.id!=="list"&&(document.title=htmx.find("article > h1").textContent||"",mermaid.run({querySelector:"article div.mermaid"}),w(b()),T())}function ot(){w(b()),v(),T()}function z(){document.addEventListener("DOMContentLoaded",tt),document.body.addEventListener("htmx:afterSwap",et),document.body.addEventListener("htmx:historyRestore",ot)}self.pathname=b;self.select=w;self.scrollToActive=v;self.toggleSidebar=E;z();
