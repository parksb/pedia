var D=new Map,M=new Map;function L(t){return document.querySelector(`script[src="${t}"]`)?Promise.resolve():new Promise((e,r)=>{let n=document.createElement("script");n.src=t,n.onload=()=>e(),n.onerror=r,document.head.appendChild(n)})}function q(t,e){D.set(t,e)}function S(){for(let[t,e]of M)document.contains(t)||(e.destroy(),M.delete(t));for(let[t,e]of D)for(let r of document.querySelectorAll(`[data-container="${t}"]`))if(!M.has(r)){let n=e();n.init(r),M.set(r,n)}}var I="https://cdn.jsdelivr.net/npm/d3@7/dist/d3.min.js";function A(t){return[typeof t.source=="string"?t.source:t.source.id,typeof t.target=="string"?t.target:t.target.id]}function R(t){let e=document.createElement("a");e.href=`/${t}`,e.setAttribute("hx-get",`/swap/${t}`),e.setAttribute("hx-target","#main"),e.setAttribute("hx-push-url",`/${t}`),e.setAttribute("hx-swap","show:top"),e.setAttribute("hx-on:click",`select('${t}') && scrollToActive()`),document.body.appendChild(e),htmx.process(e),e.click(),e.remove()}function _(t){let e=new Map;for(let r of t){let[n,c]=A(r);e.set(n,(e.get(n)??0)+1),e.set(c,(e.get(c)??0)+1)}return e}function G(t,e,r){let n=new Map,c=Math.min(e,r)*.3;for(let i=0;i<t.length;i++){let a=2*Math.PI*i/t.length;n.set(t[i],{x:e/2+c*Math.cos(a),y:r/2+c*Math.sin(a)})}return n}function N(t,e,r){let n=new Map;for(let a of t)n.set(a.id,a);let c=new Map;for(let a of t)c.set(a.id,new Set([a.category]));for(let a of e){let[l,p]=A(a),h=n.get(l),g=n.get(p);h&&g&&(c.get(l).add(g.category),c.get(p).add(h.category))}let i=new Map;for(let a of t){let l=[...c.get(a.id)];if(l.length===1||a.id===a.category)i.set(a.id,r(a.category));else{let p=0,h=0,g=0,m=0;for(let y of l){let f=y===a.category?3:1,u=d3.color(r(y)).rgb();p+=u.r*f,h+=u.g*f,g+=u.b*f,m+=f}i.set(a.id,d3.rgb(p/m,h/m,g/m).formatHex())}}return i}function V(t,e,r){return d3.forceSimulation(t).alpha(.3).alphaDecay(.03).velocityDecay(.6).force("link",d3.forceLink(e).id(n=>n.id).distance(60)).force("charge",d3.forceManyBody().strength(-100)).force("x",d3.forceX(n=>r.get(n.category).x).strength(.1)).force("y",d3.forceY(n=>r.get(n.category).y).strength(.1)).force("collision",d3.forceCollide().radius(12))}function W(t){return d3.drag().on("start",e=>{e.active||t.alphaTarget(.3).restart(),e.subject.fx=e.subject.x,e.subject.fy=e.subject.y}).on("drag",e=>{e.subject.fx=e.x,e.subject.fy=e.y}).on("end",e=>{e.active||t.alphaTarget(.01),e.subject.fx=null,e.subject.fy=null})}function B(){let t=null;return{async init(e){t?.stop(),t=null,e.replaceChildren(),await L(I);let{nodes:r,edges:n}=await fetch("/api/graph").then(o=>o.json()),c=_(n),i=new Map;for(let o of n){let[s,d]=A(o);i.has(s)||i.set(s,new Set),i.has(d)||i.set(d,new Set),i.get(s).add(d),i.get(d).add(s)}let{clientWidth:a,clientHeight:l}=e,p=[...new Set(r.map(o=>o.category))],h=d3.scaleOrdinal(d3.schemeObservable10).domain(p),g=G(p,a,l),m=N(r,n,h);for(let o of r)if(o.id==="simonpedia")o.x=a/2,o.y=l/2,o.fx=a/2,o.fy=l/2;else{let s=g.get(o.category);o.x=s.x+(Math.random()-.5)*80,o.y=s.y+(Math.random()-.5)*80}let y=d3.select(e).append("svg").attr("width",a).attr("height",l),f=y.append("g"),u=!0;y.call(d3.zoom().scaleExtent([.1,4]).on("zoom",o=>{f.attr("transform",o.transform);let s=o.transform.k>=.7;s!==u&&(u=s,T.attr("display",s?null:"none"),s&&C.attr("x",d=>d.x).attr("y",d=>d.y))})),t=V(r,n,g);let E=f.append("g").selectAll("line").data(n).join("line").attr("stroke","#ccc").attr("stroke-opacity",.6).attr("stroke-width",1),O=o=>Math.min(Math.max(3+(c.get(o.id)??0)*.8,4),20),k=f.append("g").selectAll("circle").data(r).join("circle").attr("r",O).attr("fill",o=>m.get(o.id)).attr("stroke","#fff").attr("stroke-width",1.5).attr("cursor","pointer").call(W(t)),T=f.append("g"),C=T.selectAll("text").data(r).join("text").text(o=>o.label).attr("font-size",10).attr("dx",8).attr("dy",3).attr("pointer-events","none").attr("fill","#333");k.on("mouseover",(o,s)=>{let d=i.get(s.id)??new Set,$=new Set([s.id,...d]);k.attr("opacity",x=>$.has(x.id)?1:.1),u&&C.attr("opacity",x=>$.has(x.id)?1:.1),E.attr("stroke-opacity",x=>{let[P,z]=A(x);return P===s.id||z===s.id?.8:.05})}).on("mouseout",()=>{k.attr("opacity",1),u&&C.attr("opacity",1),E.attr("stroke-opacity",.6)}).on("click",(o,s)=>R(s.id)),t.on("tick",()=>{E.attr("x1",o=>o.source.x).attr("y1",o=>o.source.y).attr("x2",o=>o.target.x).attr("y2",o=>o.target.y),k.attr("cx",o=>o.x).attr("cy",o=>o.y),u&&C.attr("x",o=>o.x).attr("y",o=>o.y)})},destroy(){t?.stop(),t=null}}}q("graph",B);function b(){let{pathname:t}=self.location;return t==="/"?"simonpedia":t?t.replace(/^\//,"").replace(/\.html$/,""):""}function v(t){return htmx.findAll("#list > ul > li").forEach(e=>htmx.removeClass(e,"active")),htmx.addClass(htmx.find(`#list > ul > li[data-key="${t}"]`),"active"),!0}function w(){return htmx.find("#list > ul > li.active").scrollIntoView({block:"center"}),!0}function j(){return htmx.toggleClass("aside","hidden"),!0}function X(){self.innerWidth<800&&j(),htmx.find("#search > input").value="",w(),S()}function Y(t){t.detail.target.id!=="list"&&(document.title=htmx.find("article > h1").textContent||"",mermaid.run({querySelector:"article div.mermaid"}),v(b()),S())}function F(){v(b()),w(),S()}function H(){document.addEventListener("DOMContentLoaded",X),document.body.addEventListener("htmx:afterSwap",Y),document.body.addEventListener("htmx:historyRestore",F)}self.pathname=b;self.select=v;self.scrollToActive=w;self.toggleSidebar=j;H();
