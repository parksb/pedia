var $=new Map,S=new Map;function q(e){return document.querySelector(`script[src="${e}"]`)?Promise.resolve():new Promise((t,a)=>{let o=document.createElement("script");o.src=e,o.onload=()=>t(),o.onerror=a,document.head.appendChild(o)})}function N(e,t){$.set(e,t)}function j(){for(let[e,t]of S)document.contains(e)||(t.destroy(),S.delete(e));for(let[e,t]of $)for(let a of document.querySelectorAll(`[data-container="${e}"]`))if(!S.has(a)){let o=t();o.init(a),S.set(a,o)}}var G="https://cdn.jsdelivr.net/npm/d3@7/dist/d3.min.js",L="simonpedia";function h(e){return[typeof e.source=="string"?e.source:e.source.id,typeof e.target=="string"?e.target:e.target.id]}function I(e){let t=document.createElement("a");t.href=`/${e}`,t.setAttribute("hx-get",`/swap/${e}`),t.setAttribute("hx-target","#main"),t.setAttribute("hx-push-url",`/${e}`),t.setAttribute("hx-swap","show:top"),t.setAttribute("hx-on:click",`select('${e}') && scrollToActive()`),document.body.appendChild(t),htmx.process(t),t.click(),t.remove()}function W(e){let t=new Map;for(let a of e){let[o,r]=h(a);t.has(o)||t.set(o,new Set),t.has(r)||t.set(r,new Set),t.get(o).add(r),t.get(r).add(o)}return t}function B(e){let t=new Map;for(let a of e){let[o,r]=h(a);t.set(o,(t.get(o)??0)+1),t.set(r,(t.get(r)??0)+1)}return t}function V(e,t,a){let o=Math.min(t,a)*.3;return new Map(e.map((r,n)=>{let s=2*Math.PI*n/e.length;return[r,{x:t/2+o*Math.cos(s),y:a/2+o*Math.sin(s)}]}))}function X(e){let{r:t,g:a,b:o,total:r}=e.reduce((n,{color:s,weight:i})=>{let l=d3.color(s).rgb();return{r:n.r+l.r*i,g:n.g+l.g*i,b:n.b+l.b*i,total:n.total+i}},{r:0,g:0,b:0,total:0});return d3.rgb(t/r,a/r,o/r).formatHex()}function Y(e,t,a){let o=new Map(e.map(n=>[n.id,n])),r=new Map(e.map(n=>[n.id,new Set([n.category])]));for(let n of t){let[s,i]=h(n),l=o.get(s),d=o.get(i);l&&d&&(r.get(s).add(d.category),r.get(i).add(l.category))}return new Map(e.map(n=>{let s=[...r.get(n.id)];return s.length===1||n.id===n.category?[n.id,a(n.category)]:[n.id,X(s.map(i=>({color:a(i),weight:i===n.category?3:1})))]}))}function F(e,t,a){let o=new Map(e.map(n=>[n.id,n])),r=new Map(e.map(n=>[n.id,new Map([[n.category,3]])]));for(let n of t){let[s,i]=h(n),l=o.get(s),d=o.get(i);if(l&&d){let u=r.get(s);u.set(d.category,(u.get(d.category)??0)+1);let f=r.get(i);f.set(l.category,(f.get(l.category)??0)+1)}}return new Map(e.map(n=>{let s=0,i=0,l=0;for(let[d,u]of r.get(n.id)){let f=a.get(d);s+=f.x*u,i+=f.y*u,l+=u}return[n.id,{x:s/l,y:i/l}]}))}function J(e,t,a,o){for(let r of e)if(r.id===L)r.x=a/2,r.y=o/2,r.fx=a/2,r.fy=o/2;else{let n=t.get(r.id);r.x=n.x+(Math.random()-.5)*80,r.y=n.y+(Math.random()-.5)*80}}function K(e,t,a){return d3.forceSimulation(e).alpha(.3).alphaDecay(.03).velocityDecay(.6).force("link",d3.forceLink(t).id(o=>o.id).distance(o=>{let[r,n]=h(o);return r===L||n===L?300:100})).force("charge",d3.forceManyBody().strength(-200)).force("x",d3.forceX(o=>a.get(o.id).x).strength(.3)).force("y",d3.forceY(o=>a.get(o.id).y).strength(.3)).force("collision",d3.forceCollide().radius(16))}function Q(e){return d3.drag().on("start",t=>{t.active||e.alphaTarget(.3).restart(),t.subject.fx=t.subject.x,t.subject.fy=t.subject.y}).on("drag",t=>{t.subject.fx=t.x,t.subject.fy=t.y}).on("end",t=>{t.active||e.alphaTarget(.01),t.subject.fx=null,t.subject.fy=null})}function U(){let e=null;return{async init(t){e?.stop(),e=null,t.replaceChildren(),await q(G);let{nodes:a,edges:o}=await fetch("/api/graph").then(c=>c.json()),r=W(o),n=B(o),{clientWidth:s,clientHeight:i}=t,l=[...new Set(a.map(c=>c.category))],d=d3.scaleOrdinal(d3.schemeObservable10).domain(l),u=V(l,s,i),f=F(a,o,u),R=Y(a,o,d);J(a,f,s,i);let O=d3.select(t).append("svg").attr("width",s).attr("height",i),v=O.append("g"),m=d3.zoomIdentity,z=Math.min(s,i)*.8;function T(){if(m.k<.7){k.attr("opacity",0);return}let c=(s/2-m.x)/m.k,p=(i/2-m.y)/m.k;k.attr("opacity",C=>{let y=(C.x??0)-c,g=(C.y??0)-p,D=Math.sqrt(y*y+g*g);return Math.max(0,1-D/(z/m.k))})}O.call(d3.zoom().scaleExtent([.1,4]).on("zoom",c=>{m=c.transform,v.attr("transform",c.transform),T()})),e=K(a,o,f);let E=v.append("g").selectAll("line").data(o).join("line").attr("stroke","#ccc").attr("stroke-opacity",.6).attr("stroke-width",1),H=c=>3+Math.log2(1+(n.get(c.id)??0))*4,M=v.append("g").selectAll("circle").data(a).join("circle").attr("r",H).attr("fill",c=>R.get(c.id)).attr("stroke","#fff").attr("stroke-width",1.5).attr("cursor","pointer").call(Q(e)),k=v.append("g").selectAll("text").data(a).join("text").text(c=>c.label).attr("font-size",10).attr("dx",8).attr("dy",3).attr("pointer-events","none").attr("fill","#333").attr("stroke","#fff").attr("stroke-width",1).attr("paint-order","stroke");M.on("mouseover",(c,p)=>{let C=r.get(p.id)??new Set,y=new Set([p.id,...C]);M.attr("opacity",g=>y.has(g.id)?1:.1),k.attr("opacity",g=>y.has(g.id)?1:.1),E.attr("stroke-opacity",g=>{let[D,_]=h(g);return D===p.id||_===p.id?.8:.05})}).on("mouseout",()=>{M.attr("opacity",1),T(),E.attr("stroke-opacity",.6)}).on("click",(c,p)=>I(p.id)),e.on("tick",()=>{E.attr("x1",c=>c.source.x).attr("y1",c=>c.source.y).attr("x2",c=>c.target.x).attr("y2",c=>c.target.y),M.attr("cx",c=>c.x).attr("cy",c=>c.y),k.attr("x",c=>c.x).attr("y",c=>c.y),T()})},destroy(){e?.stop(),e=null}}}N("graph",U);function x(){let{pathname:e}=self.location;return e==="/"?"simonpedia":e?e.replace(/^\//,"").replace(/\.html$/,""):""}function b(e){return htmx.findAll("#list > ul > li").forEach(t=>htmx.removeClass(t,"active")),htmx.addClass(htmx.find(`#list > ul > li[data-key="${e}"]`),"active"),!0}function w(){return htmx.find("#list > ul > li.active").scrollIntoView({block:"center"}),!0}function A(){return htmx.toggleClass("aside","hidden"),!0}function Z(){self.innerWidth<800&&A(),htmx.find("#search > input").value="",w(),j()}function tt(e){e.detail.target.id!=="list"&&(document.title=htmx.find("article > h1").textContent||"",mermaid.run({querySelector:"article div.mermaid"}),b(x()),j())}function et(){b(x()),w(),j()}function P(){document.addEventListener("DOMContentLoaded",Z),document.body.addEventListener("htmx:afterSwap",tt),document.body.addEventListener("htmx:historyRestore",et)}self.pathname=x;self.select=b;self.scrollToActive=w;self.toggleSidebar=A;P();
