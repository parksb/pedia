function f(){let{pathname:n}=self.location;return n==="/"?"simonpedia":n?n.replace(/^\//,"").replace(/\.html$/,""):""}function p(n){return htmx.findAll("#list > ul > li").forEach(t=>htmx.removeClass(t,"active")),htmx.addClass(htmx.find(`#list > ul > li[data-key="${n}"]`),"active"),!0}function h(){return htmx.find("#list > ul > li.active").scrollIntoView({block:"center"}),!0}function b(){return htmx.toggleClass("aside","hidden"),!0}var I="https://cdn.jsdelivr.net/npm/d3@7/dist/d3.min.js",m=null;function k(n){return[typeof n.source=="string"?n.source:n.source.id,typeof n.target=="string"?n.target:n.target.id]}function O(n){return document.querySelector(`script[src="${n}"]`)?Promise.resolve():new Promise((t,a)=>{let r=document.createElement("script");r.src=n,r.onload=()=>t(),r.onerror=a,document.head.appendChild(r)})}function P(n){let t=document.createElement("a");t.href=`/${n}`,t.setAttribute("hx-get",`/swap/${n}`),t.setAttribute("hx-target","#main"),t.setAttribute("hx-push-url",`/${n}`),t.setAttribute("hx-swap","show:top"),t.setAttribute("hx-on:click",`select('${n}') && scrollToActive()`),document.body.appendChild(t),htmx.process(t),t.click(),t.remove()}function z(n){let t=new Map;for(let a of n){let[r,i]=k(a);t.set(r,(t.get(r)??0)+1),t.set(i,(t.get(i)??0)+1)}return t}function G(n,t,a){let r=new Map,i=Math.min(t,a)*.3;for(let s=0;s<n.length;s++){let l=2*Math.PI*s/n.length;r.set(n[s],{x:t/2+i*Math.cos(l),y:a/2+i*Math.sin(l)})}return r}function R(n,t,a){return d3.forceSimulation(n).alpha(.3).alphaDecay(.03).velocityDecay(.6).force("link",d3.forceLink(t).id(r=>r.id).distance(60)).force("charge",d3.forceManyBody().strength(-100)).force("x",d3.forceX(r=>a.get(r.category).x).strength(.1)).force("y",d3.forceY(r=>a.get(r.category).y).strength(.1)).force("collision",d3.forceCollide().radius(12))}function _(n){return d3.drag().on("start",t=>{t.active||n.alphaTarget(.3).restart(),t.subject.fx=t.subject.x,t.subject.fy=t.subject.y}).on("drag",t=>{t.subject.fx=t.x,t.subject.fy=t.y}).on("end",t=>{t.active||n.alphaTarget(0),t.subject.fx=null,t.subject.fy=null})}async function v(){m?.stop(),m=null;let n=document.getElementById("graph-container");if(!n)return;n.replaceChildren(),await O(I);let{nodes:t,edges:a}=await fetch("/api/graph").then(e=>e.json()),r=z(a),i=new Map;for(let e of a){let[o,c]=k(e);i.has(o)||i.set(o,new Set),i.has(c)||i.set(c,new Set),i.get(o).add(c),i.get(c).add(o)}let{clientWidth:s,clientHeight:l}=n,S=[...new Set(t.map(e=>e.category))],T=d3.scaleOrdinal(d3.schemeObservable10).domain(S),j=G(S,s,l);for(let e of t)if(e.id==="simonpedia")e.x=s/2,e.y=l/2,e.fx=s/2,e.fy=l/2;else{let o=j.get(e.category);e.x=o.x+(Math.random()-.5)*80,e.y=o.y+(Math.random()-.5)*80}let A=d3.select(n).append("svg").attr("width",s).attr("height",l),g=A.append("g"),d=!0;A.call(d3.zoom().scaleExtent([.1,4]).on("zoom",e=>{g.attr("transform",e.transform);let o=e.transform.k>=.7;o!==d&&(d=o,C.attr("display",o?null:"none"),o&&x.attr("x",c=>c.x).attr("y",c=>c.y))})),m=R(t,a,j);let w=g.append("g").selectAll("line").data(a).join("line").attr("stroke","#ccc").attr("stroke-opacity",.6).attr("stroke-width",1),D=e=>Math.min(Math.max(3+(r.get(e.id)??0)*.8,4),20),y=g.append("g").selectAll("circle").data(t).join("circle").attr("r",D).attr("fill",e=>T(e.category)).attr("stroke","#fff").attr("stroke-width",1.5).attr("cursor","pointer").call(_(m)),C=g.append("g"),x=C.selectAll("text").data(t).join("text").text(e=>e.label).attr("font-size",10).attr("dx",8).attr("dy",3).attr("pointer-events","none").attr("fill","#333");y.on("mouseover",(e,o)=>{let c=i.get(o.id)??new Set,M=new Set([o.id,...c]);y.attr("opacity",u=>M.has(u.id)?1:.1),d&&x.attr("opacity",u=>M.has(u.id)?1:.1),w.attr("stroke-opacity",u=>{let[L,$]=k(u);return L===o.id||$===o.id?.8:.05})}).on("mouseout",()=>{y.attr("opacity",1),d&&x.attr("opacity",1),w.attr("stroke-opacity",.6)}).on("click",(e,o)=>P(o.id)),m.on("tick",()=>{w.attr("x1",e=>e.source.x).attr("y1",e=>e.source.y).attr("x2",e=>e.target.x).attr("y2",e=>e.target.y),y.attr("cx",e=>e.x).attr("cy",e=>e.y),d&&x.attr("x",e=>e.x).attr("y",e=>e.y)})}function q(){self.innerWidth<800&&b(),htmx.find("#search > input").value="",h(),v()}function B(n){n.detail.target.id!=="list"&&(document.title=htmx.find("article > h1").textContent||"",mermaid.run({querySelector:"article div.mermaid"}),p(f()),v())}function H(){p(f()),h(),v()}function E(){document.addEventListener("DOMContentLoaded",q),document.body.addEventListener("htmx:afterSwap",B),document.body.addEventListener("htmx:historyRestore",H)}self.pathname=f;self.select=p;self.scrollToActive=h;self.toggleSidebar=b;E();
