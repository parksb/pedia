var F=new Map,j=new Map;function N(t){return document.querySelector(`script[src="${t}"]`)?Promise.resolve():new Promise((e,s)=>{let n=document.createElement("script");n.src=t,n.onload=()=>e(),n.onerror=s,document.head.appendChild(n)})}function Y(t,e){F.set(t,e)}function q(){for(let[t,e]of j)document.contains(t)||(e.destroy(),j.delete(t));for(let[t,e]of F)for(let s of document.querySelectorAll(`[data-container="${t}"]`))if(!j.has(s)){let n=e();n.init(s),j.set(s,n)}}var K="https://cdn.jsdelivr.net/npm/d3@7/dist/d3.min.js",B="simonpedia";function C(t){return[typeof t.source=="string"?t.source:t.source.id,typeof t.target=="string"?t.target:t.target.id]}function V(t){let e=document.createElement("a");e.href=`/${t}`,e.setAttribute("hx-get",`/swap/${t}`),e.setAttribute("hx-target","#main"),e.setAttribute("hx-push-url",`/${t}`),e.setAttribute("hx-swap","show:top"),e.setAttribute("hx-on:click",`select('${t}') && scrollToActive()`),document.body.appendChild(e),htmx.process(e),e.click(),e.remove()}function z(t){let e=new Map;for(let s of t){let[n,o]=C(s);e.has(n)||e.set(n,new Set),e.has(o)||e.set(o,new Set),e.get(n).add(o),e.get(o).add(n)}return e}function Q(t){let e=new Map;for(let s of t){let[n,o]=C(s);e.set(n,(e.get(n)??0)+1),e.set(o,(e.get(o)??0)+1)}return e}function U(t,e,s){let n=Math.min(e,s)*.3;return new Map(t.map((o,r)=>{let c=2*Math.PI*r/t.length;return[o,{x:e/2+n*Math.cos(c),y:s/2+n*Math.sin(c)}]}))}function Z(t){let{r:e,g:s,b:n,total:o}=t.reduce((r,{color:c,weight:l})=>{let i=d3.color(c).rgb();return{r:r.r+i.r*l,g:r.g+i.g*l,b:r.b+i.b*l,total:r.total+l}},{r:0,g:0,b:0,total:0});return d3.rgb(e/o,s/o,n/o).formatHex()}function tt(t,e,s){let n=new Map(t.map(r=>[r.id,r])),o=new Map(t.map(r=>[r.id,new Set([r.category])]));for(let r of e){let[c,l]=C(r),i=n.get(c),f=n.get(l);i&&f&&(o.get(c).add(f.category),o.get(l).add(i.category))}return new Map(t.map(r=>{let c=[...o.get(r.id)];return c.length===1||r.id===r.category?[r.id,s(r.category)]:[r.id,Z(c.map(l=>({color:s(l),weight:l===r.category?3:1})))]}))}function et(t,e,s){let n=new Map(t.map(r=>[r.id,r])),o=new Map(t.map(r=>[r.id,new Map([[r.category,3]])]));for(let r of e){let[c,l]=C(r),i=n.get(c),f=n.get(l);if(i&&f){let m=o.get(c);m.set(f.category,(m.get(f.category)??0)+1);let u=o.get(l);u.set(i.category,(u.get(i.category)??0)+1)}}return new Map(t.map(r=>{let c=0,l=0,i=0;for(let[f,m]of o.get(r.id)){let u=s.get(f);c+=u.x*m,l+=u.y*m,i+=m}return[r.id,{x:c/i,y:l/i}]}))}function nt(t,e,s,n){for(let o of t)if(o.id===B)o.x=s/2,o.y=n/2,o.fx=s/2,o.fy=n/2;else{let r=e.get(o.id);o.x=r.x+(Math.random()-.5)*80,o.y=r.y+(Math.random()-.5)*80}}function ot(t,e,s){return d3.forceSimulation(t).alpha(.3).alphaDecay(.03).velocityDecay(.6).force("link",d3.forceLink(e).id(n=>n.id).distance(n=>{let[o,r]=C(n);return o===B||r===B?300:100})).force("charge",d3.forceManyBody().strength(-200)).force("x",d3.forceX(n=>s.get(n.id).x).strength(.3)).force("y",d3.forceY(n=>s.get(n.id).y).strength(.3)).force("collision",d3.forceCollide().radius(16))}var X=(t,e)=>3+Math.log2(1+(e.get(t.id)??0))*4;function rt(t,e,s){let n=globalThis.devicePixelRatio||1,o=document.createElement("canvas");o.width=e*n,o.height=s*n,o.style.width=`${e}px`,o.style.height=`${s}px`,o.style.display="block";let r=o.getContext("2d");return r.scale(n,n),t.appendChild(o),{canvas:o,ctx:r}}function G(t,e,s,n,o){let r=(s-o.x)/o.k,c=(n-o.y)/o.k;for(let l=t.length-1;l>=0;l--){let i=t[l],f=X(i,e),m=(i.x??0)-r,u=(i.y??0)-c;if(m*m+u*u<=f*f)return i}return null}function st(t,e,s,n,o,r,c,l,i,f,m){t.clearRect(0,0,e,s),t.save(),t.translate(i.x,i.y),t.scale(i.k,i.k);let u=1/i.k,v=f?new Set([f.id,...l.get(f.id)??[]]):null,A=new Path2D,L=new Path2D;for(let d of o){let w=d.source,a=d.target,[b,h]=C(d),k=v&&(b===f.id||h===f.id)?L:A;k.moveTo(w.x,w.y),k.lineTo(a.x,a.y)}t.lineWidth=u,t.strokeStyle="#ccc",t.globalAlpha=v?.05:.6,t.stroke(A),v&&(t.globalAlpha=.8,t.stroke(L));for(let d of n){let w=X(d,r);t.globalAlpha=v?v.has(d.id)?1:.1:1,t.beginPath(),t.arc(d.x,d.y,w,0,Math.PI*2),t.fillStyle=c.get(d.id),t.fill(),t.strokeStyle="#fff",t.lineWidth=1.5*u,t.stroke()}if(i.k>=.7){let d=(e/2-i.x)/i.k,w=(s/2-i.y)/i.k;t.font=`${10*u}px sans-serif`,t.textBaseline="middle",t.lineWidth=2*u,t.lineJoin="round",t.strokeStyle="#fff";for(let a of n){let b=v?v.has(a.id)?1:.1:Math.max(0,1-Math.hypot((a.x??0)-d,(a.y??0)-w)/(m*u));b<=0||(t.globalAlpha=b,t.strokeText(a.label,a.x+8*u,a.y+3*u),t.fillStyle="#333",t.fillText(a.label,a.x+8*u,a.y+3*u))}}t.restore(),t.globalAlpha=1}function it(){let t=null,e=null;return{async init(s){t?.stop(),t=null,s.replaceChildren(),await N(K);let{nodes:n,edges:o}=await fetch("/api/graph").then(g=>g.json()),r=z(o),c=Q(o),{clientWidth:l,clientHeight:i}=s,f=Math.min(l,i)*.8,m=[...new Set(n.map(g=>g.category))],u=d3.scaleOrdinal(d3.schemeObservable10).domain(m),v=U(m,l,i),A=et(n,o,v),L=tt(n,o,u);nt(n,A,l,i);let{canvas:d,ctx:w}=rt(s,l,i),a={x:0,y:0,k:1},b=null,h=null,S=!1,k={x:0,y:0},H={x:0,y:0},I={x:0,y:0},$=null,M=()=>{e===null&&(e=requestAnimationFrame(()=>{e=null,st(w,l,i,n,o,c,L,r,a,b,f)}))},J=(g,y)=>({x:(g-a.x)/a.k,y:(y-a.y)/a.k}),O=g=>{let y=d.getBoundingClientRect();return{x:g.clientX-y.left,y:g.clientY-y.top}};d.addEventListener("mousedown",g=>{let{x:y,y:x}=O(g);I={x:y,y:x};let p=G(n,c,y,x,a);p?(h=p,$=p,p.fx=p.x,p.fy=p.y,t.alphaTarget(.3).restart()):(S=!0,k={x:y,y:x},H={x:a.x,y:a.y},d.style.cursor="grabbing")}),d.addEventListener("mousemove",g=>{let{x:y,y:x}=O(g);if(h){let p=J(y,x);h.fx=p.x,h.fy=p.y,M()}else if(S)a={...a,x:H.x+y-k.x,y:H.y+x-k.y},M();else{let p=G(n,c,y,x,a);p!==b&&(b=p,d.style.cursor=p?"pointer":"default",M())}}),d.addEventListener("mouseup",g=>{let{x:y,y:x}=O(g),p=y-I.x,T=x-I.y,R=p*p+T*T>25;h&&(t.alphaTarget(.01),h.fx=null,h.fy=null,!R&&$===h&&V(h.id),h=null,$=null),S=!1,d.style.cursor=b?"pointer":"default"}),d.addEventListener("mouseleave",()=>{h&&(t.alphaTarget(.01),h.fx=null,h.fy=null,h=null,$=null),S=!1,b=null,d.style.cursor="default",M()}),d.addEventListener("wheel",g=>{g.preventDefault();let{x:y,y:x}=O(g),p=g.deltaY<0?1.1:1/1.1,T=Math.max(.1,Math.min(4,a.k*p)),R=T/a.k;a={k:T,x:y-(y-a.x)*R,y:x-(x-a.y)*R},M()},{passive:!1}),t=ot(n,o,A),t.on("tick",M)},destroy(){e!==null&&cancelAnimationFrame(e),e=null,t?.stop(),t=null}}}Y("graph",it);function E(){let{pathname:t}=self.location;return t==="/"?"simonpedia":t?t.replace(/^\//,"").replace(/\.html$/,""):""}function P(t){return htmx.findAll("#list > ul > li").forEach(e=>htmx.removeClass(e,"active")),htmx.addClass(htmx.find(`#list > ul > li[data-key="${t}"]`),"active"),!0}function D(){return htmx.find("#list > ul > li.active").scrollIntoView({block:"center"}),!0}function W(){return htmx.toggleClass("aside","hidden"),!0}function at(){self.innerWidth<800&&W(),htmx.find("#search > input").value="",D(),q()}function lt(t){t.detail.target.id!=="list"&&(document.title=htmx.find("article > h1").textContent||"",mermaid.run({querySelector:"article div.mermaid"}),P(E()),q())}function ct(){P(E()),D(),q()}function _(){document.addEventListener("DOMContentLoaded",at),document.body.addEventListener("htmx:afterSwap",lt),document.body.addEventListener("htmx:historyRestore",ct)}self.pathname=E;self.select=P;self.scrollToActive=D;self.toggleSidebar=W;_();
